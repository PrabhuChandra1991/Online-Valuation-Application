<div class="container">
    <h3>Answersheet Consolidated View</h3>
    <div class="row mt-4">
        <div class="col-lg-3 col-md-5">
            <select id="institutionId" class="form-select" (change)="onInstituteChange($event)">
                <option [value]="">Select Institution</option>
                <option *ngFor="let inst of institutes" [value]="inst.institutionId">
                    {{ inst.name }}
                </option>
            </select>
        </div>
        <div class="col-lg-3 col-md-2">
            <!-- Search Input -->
            <input class="form-control" (keyup)="applyFilter($event)" placeholder="Search">
        </div>
        <div class="col-lg-6 col-md-5 d-grid">
            <!-- <button class="btn btn-primary float-end me-1" (click)="openCreateUserDialog()"><i data-feather="user-plus"
            height="1rem" appFeatherIcon></i>&nbsp;Create User</button> -->
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-12 custom-table-style">
            <div class="table-responsive">

                <!-- Table -->
                <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8">
                    <!-- Name Column -->
                    <ng-container matColumnDef="institutionCode">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Institution
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.institutionCode }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="regulationYear">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Regulation
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.regulationYear }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="batchYear">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Batch</th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.batchYear }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="degreeType">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Degree Type
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.degreeType }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="examType">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Exam Type
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.examType }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="semester">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Semester
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.semester }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="courseCode">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Course Code
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.courseCode }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="examMonth">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Exam Month
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.examMonth }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="examYear">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Exam Year
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.examYear }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="studentTotalCount">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Student Count
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.studentTotalCount }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="answerSheetTotalCount">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Total Answersheets
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.answerSheetTotalCount }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="answerSheetAllocatedCount">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Allocated answersheets
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.answerSheetAllocatedCount }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="answerSheetNotAllocatedCount">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>
                            Not allocated answersheets
                        </th>
                        <td mat-cell *matCellDef="let element">
                            <a>
                                {{ element.answerSheetNotAllocatedCount }} </a>
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                        <td mat-cell *matCellDef="let element">
                            <a class="link-opacity-50-hover" (click)="allocationDialog(element)">Allocate</a>
                        </td>
                    </ng-container>

                    <!-- Table Header & Row Definitions -->
                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>

            </div>

            <!-- Pagination -->
            <mat-paginator class="mt-3 pagination" [pageSizeOptions]="[10, 20, 30, 50]"
                showFirstLastButtons></mat-paginator>

        </div>
    </div>

</div>

<!-- User Modal -->
<ng-template #allocateModal let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Allocate answersheet</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
    </div>
    <div class="modal-body">
        <form [formGroup]="allocateAnswersheetForm">

            <div class="row mb-3">
                <div class="col-sm-6">
                    <label>Student count</label>
                </div>
                <div class="col-sm-6">
                    <label>{{selectedElement.studentTotalCount}}</label>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-sm-6">
                    <label>Total Answersheet</label>
                </div>
                <div class="col-sm-6">
                    <label>{{selectedElement.answerSheetTotalCount}}</label>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-sm-6">
                    <label>Allocated Answersheets</label>
                </div>
                <div class="col-sm-6">
                    <label>{{selectedElement.answerSheetAllocatedCount}}</label>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-sm-6">
                    <label>Not Allocated
                        Answersheets</label>
                </div>
                <div class="col-sm-6">
                    <label>{{selectedElement.answerSheetNotAllocatedCount}}</label>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-sm-6">
                    <label>Allocate to <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="userId" (change)="updateAllocation($event)">
                        <option value="">Select Expert</option>
                        <option *ngFor="let user of users" [value]="user.userId"
                        [disabled]="disableIfAdmin(user.userId)">
                            {{ user.userName }}
                        </option>
                    </select>
                </div>
                <div class="col-sm-6" *ngIf="enterAllocation">
                    <label>Number of answersheets <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="noOfAnswersheetsAllocated"
                        maxlength="4" pattern="[0-9]*" />
                        <span class="text-danger"
                        *ngIf="(allocateAnswersheetForm.controls.collegeName.touched) && 
                        allocateAnswersheetForm.controls.collegeName.hasError('pattern')">
                        Only numbers allowed
                      </span>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-danger" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-primary" [disabled]="!allocateAnswersheetForm.valid"
            (click)="saveAllocation()">Allocate</button>
    </div>
</ng-template>